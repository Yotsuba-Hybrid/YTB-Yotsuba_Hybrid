name: üîÑ Update Engine & Tools

on: 
  workflow_dispatch:
    inputs:
      target_branch:
        description: 'Rama oficial a descargar (develop/master)'
        required: true
        default: 'YTB-Master'

permissions:
  contents: write
  pull-requests: write

jobs:
  update-engine:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout User Repo
        uses: actions/checkout@v4

      - name: Checkout Official Engine
        uses: actions/checkout@v4
        with:
          # EDITADO: Ahora la fuente de la verdad es tu repositorio oficial
          repository: 'Yotsuba-Hybrid/YTB-Yotsuba_Hybrid'
          ref: ${{ inputs.target_branch }}
          path: 'temp_official_source'

      - name: Sync Components
        run: |
          # ---------------- CONFIGURACI√ìN ----------------
          # Lista de archivos y carpetas a sincronizar
          # Aseg√∫rate de que estas carpetas existan en la ra√≠z de Yotsuba-Hybrid
          ITEMS_TO_SYNC=(
            "YotsubaEngine"
            "YTBContentBuilder"
          )
          # -----------------------------------------------

          echo "üöÄ Iniciando actualizaci√≥n inteligente..."

          for item in "${ITEMS_TO_SYNC[@]}"; do
            echo "------------------------------------------------"
            echo "üì¶ Procesando: $item"

            # 1. Verificar existencia en el origen (Oficial)
            if [ ! -e "temp_official_source/$item" ]; then
              echo "‚ùå Error Cr√≠tico: No se encontr√≥ '$item' en el repositorio oficial (Yotsuba-Hybrid)."
              exit 1
            fi

            # 2. Borrar versi√≥n antigua local
            if [ -e "$item" ]; then
               echo "üóëÔ∏è  Eliminando versi√≥n antigua..."
               rm -rf "$item"
            else
               echo "‚ú® El elemento es nuevo para este repo."
            fi

            # 3. Preparar destino y Copiar
            echo "üîÑ Copiando nueva versi√≥n..."
            
            # Aseguramos que la carpeta contenedora exista
            mkdir -p "$(dirname "$item")"
            
            # Copiamos preservando atributos
            cp -rp "temp_official_source/$item" "$item"
            
            echo "‚úÖ Actualizado correctamente."
          done

          # Limpieza final
          rm -rf temp_official_source
          echo "------------------------------------------------"
          echo "üéâ Sincronizaci√≥n completa."

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore(engine): Update Core, Tools & Workflows"
          title: "üîÑ Update Engine Core & Updater"
          body: |
            Este PR actualiza los componentes del motor y sus herramientas a la √∫ltima versi√≥n de la rama `${{ inputs.target_branch }}` del repositorio oficial **Yotsuba-Hybrid**.
            
            **Componentes actualizados:**
            * `YotsubaEngine` (Core)
            * `YTBContentBuilder` (Tools)
            * `.github/workflows/update-engine.yaml` (L√≥gica de actualizaci√≥n)
            
            ‚ö†Ô∏è *Se han reemplazado estos elementos con la versi√≥n oficial. Revisa los cambios antes de aceptar.*
          branch: "update/engine-full-sync"
          base: ${{ github.ref_name }}
